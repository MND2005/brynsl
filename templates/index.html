<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=2.0, minimum-scale=0.5">
    <meta name="theme-color" content="#6e48aa">
    <title>BRYN</title>
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='favicon.jpg') }}">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <header class="chat-header animate__animated animate__fadeIn">
            <h1>BRYN</h1>
            <button id="settings-btn" title="Settings">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <div id="settings-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>Settings</h3>
                    <div class="settings-options">
                        <div class="language-selector">
                            <div class="language-wrapper">
                                <label for="language">Language:</label>
                                <select id="language" name="language" class="language-dropdown">
                                    <option value="sinhala">Sinhala</option>
                                    <option value="english">English</option>
                                    <option value="tamil">Tamil</option>
                                    <option value="add-new" class="add-option">+ Add Language</option>
                                </select>
                            </div>
                        </div>
                        <a href="{{ url_for('profile') }}" class="settings-link">
                            <i class="fa fa-user" aria-hidden="true"></i> Profile
                        </a>
                        <a href="{{ url_for('user_notifications') }}" class="settings-link notification-link">
                            <div class="notification-icon-wrapper">
                                <i class="fa fa-bell{% if unread_count > 0 %} glowing{% endif %}" aria-hidden="true"></i>
                                {% if unread_count > 0 %}
                                <span class="pulse-ring"></span>
                                <span class="shine"></span>
                                {% endif %}
                            </div> Notifications
                        </a>
                        <button id="clear-history-settings" class="settings-link" title="Clear history">
                            <i class="fa fa-trash-alt"></i> Clear History
                        </button>
                        
                        <a href="{{ url_for('ideas') }}" class="settings-link">
                            <i class="fa fa-paper-plane"></i>Send Feedbacks / Errors
                        </a>

                        <a href="{{ url_for('logout') }}" class="settings-link logout-btn">
                            <i class="fa fa-sign-out" aria-hidden="true"></i> Logout
                        </a>
                    </div>
                    <div class="modal-buttons">
                        <button onclick="closeSettingsModal(event)">Close</button>
                    </div>
                </div>
            </div>
            <div id="language-modal" class="modal language-submodal" style="display: none;">
                <div class="modal-content">
                    <h3>Add New Language</h3>
                    <input type="text" id="custom-language" placeholder="Enter language name">
                    <div class="modal-buttons">
                        <button id="add-language-btn">Add</button>
                        <button onclick="closeLanguageModal()">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </header>
        <div class="preview-modal" id="preview-modal">
            <div class="preview-content">
                <div class="preview-actions">
                    <button class="crop-btn cancel-preview" onclick="startCrop()" style="display: none;" id="crop-btn">
                        <i class="fas fa-crop"></i> Crop
                    </button>
                    <button class="confirm-crop-btn cancel-preview" onclick="confirmCrop()" style="display: none;" id="confirm-crop-btn">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="cancel-preview" onclick="closePreview()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                <img id="full-preview" src="" alt="Image preview">
                <div class="cropper-container" id="cropper-container" style="display: none;">
                    <img id="cropper-image" src="" alt="Image to crop">
                </div>
                <div class="preview-input">
                    <textarea id="preview-question" name="preview-question" placeholder="Type your message..." rows="1"></textarea>
                </div>
                <div class="preview-actions">
                    <button class="send-preview" onclick="sendPreview()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot-message animate__animated animate__fadeIn">
                <div class="message-content">
                    <div class="message-sender">BRYN AI BOT</div>
                    <div class="message-text">Welcome to BRYN, your ultimate student guide powered by Cosmosl! ðŸš€ Upload an image of your question or type it in, and I'll provide a clear, accurate answer to help you ace your studies. Let's make learning a breezeâ€”startÂ exploringÂ now!</div>
                    <div class="message-actions">
                        <button class="copy-btn" onclick="copyMessage(this)"><i class="far fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-input">
            <form id="question-form" class="message-form">
                <div class="input-group">
                    <div class="input-buttons">
                        <label for="image" class="file-upload">
                            <i class="fas fa-image"></i>
                            <input type="file" id="image" name="image" accept="image/*">
                        </label>
                        <label class="file-upload">
                            <button type="button" id="camera-btn" class="camera-button" title="Take a photo">
                                <i class="fas fa-camera"></i>
                            </button>
                        </label>
                    </div>
                    <textarea id="question" name="question" placeholder="Type your message..." rows="1"></textarea>
                    <div class="input-buttons">
                        <button type="submit" class="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="camera-modal" id="camera-modal" style="display: none;">
        <div class="camera-content">
            <video id="camera-video" autoplay></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            <div class="camera-actions">
                <button id="capture-btn" onclick="captureImage()">Capture</button>
                <button id="flash-btn" onclick="toggleFlash()">Flash: Off</button>
                <button onclick="closeCameraModal()">Cancel</button>
            </div>
        </div>
    </div>
    <div class="toast" id="toast">Copied to clipboard!</div>

    <script>
        // Define settingsModal globally
        const settingsModal = document.getElementById('settings-modal');

        // Define closeSettingsModal globally
        function closeSettingsModal(event) {
            if (event) event.stopPropagation(); // Prevent event bubbling
            if (!settingsModal) {
                console.error('Settings modal not found');
                return;
            }
            console.log('Closing settings modal');
            settingsModal.classList.remove('show');
            settingsModal.style.display = 'none'; // Immediate hide as fallback
            setTimeout(() => {
                settingsModal.style.display = 'none'; // Ensure hidden after transition
                console.log('Settings modal hidden');
            }, 300);
        }

        const languageModal = document.getElementById('language-modal');
        
        function closeLanguageModal() {
                languageModal.classList.remove('show');
                setTimeout(() => {
                    languageModal.style.display = 'none';
                    settingsModal.style.display = 'flex';
                    setTimeout(() => settingsModal.classList.add('show'), 10);
                    languageSelector.value = localStorage.getItem('selectedLanguage') || 'sinhala';
                }, 300);
            }

        document.addEventListener('DOMContentLoaded', function () {
            loadMessages();
            const languageSelector = document.getElementById('language');
            const languageModal = document.getElementById('language-modal');
            const customLanguageInput = document.getElementById('custom-language');
            const addLanguageButton = document.getElementById('add-language-btn');
            const settingsButton = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const previewQuestionInput = document.getElementById('preview-question');

            settingsButton.addEventListener('click', function () {
                settingsModal.style.display = 'flex';
            });

            document.getElementById('clear-history-settings').addEventListener('click', (e) => {
                if (confirm('Are you sure you want to clear all chat history?')) {
                    clearMessageHistory();
                    showToast('Chat history cleared');
                }
            });
            function closeSettingsModal(event) {
                if (event) event.stopPropagation(); // Prevent event bubbling
                if (!settingsModal) {
                    console.error('Settings modal not found');
                    return;
                }
                console.log('Closing settings modal');
                settingsModal.classList.remove('show');
                settingsModal.style.display = 'none'; // Immediate hide as fallback
                setTimeout(() => {
                    settingsModal.style.display = 'none'; // Ensure hidden after transition
                    console.log('Settings modal hidden');
                }, 300);
            }
            // Load saved language
            const savedLanguage = localStorage.getItem('selectedLanguage');
            if (savedLanguage && isLanguageInDropdown(savedLanguage)) {
                languageSelector.value = savedLanguage;
            }

            // Load custom languages
            const customLanguages = JSON.parse(localStorage.getItem('customLanguages') || '[]');
            customLanguages.forEach(lang => addLanguageToDropdown(lang));

            // Handle language change
            languageSelector.addEventListener('change', function () {
                if (this.value === 'add-new') {
                    openLanguageModal();
                } else {
                    localStorage.setItem('selectedLanguage', this.value);
                    console.log('Language changed to:', this.value);
                }
            });

            // Handle add language button in modal
            addLanguageButton.addEventListener('click', function () {
                const newLang = customLanguageInput.value.trim();
                if (!newLang) {
                    showToast('Please enter a language name', 'warning');
                    return;
                }

                if (isLanguageInDropdown(newLang)) {
                    showToast('Language already exists', 'warning');
                    return;
                }

                addLanguageToDropdown(newLang);
                saveCustomLanguage(newLang);
                localStorage.setItem('selectedLanguage', newLang.toLowerCase());
                languageSelector.value = newLang.toLowerCase();
                showToast('Language added successfully!');
                closeLanguageModal();
            });

            customLanguageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addLanguageButton.click();
                }
            });

             // Settings modal handling
            settingsButton.addEventListener('click', function (e) {
                e.preventDefault();
                settingsModal.style.display = 'flex';
                setTimeout(() => settingsModal.classList.add('show'), 10);
            });

            function openLanguageModal() {
                settingsModal.style.display = 'none';
                settingsModal.classList.remove('show');
                languageModal.style.display = 'flex';
                setTimeout(() => languageModal.classList.add('show'), 10);
                customLanguageInput.focus();
            }

            function closeLanguageModal() {
                languageModal.classList.remove('show');
                setTimeout(() => {
                    languageModal.style.display = 'none';
                    settingsModal.style.display = 'flex';
                    setTimeout(() => settingsModal.classList.add('show'), 10);
                    languageSelector.value = localStorage.getItem('selectedLanguage') || 'sinhala';
                }, 300);
            }

           
            function isLanguageInDropdown(language) {
                return Array.from(languageSelector.options).some(opt => opt.value.toLowerCase() === language.toLowerCase());
            }

            function addLanguageToDropdown(language) {
                const addOption = document.querySelector('#language option[value="add-new"]');
                const newOption = document.createElement('option');
                newOption.value = language.toLowerCase();
                newOption.textContent = language;
                languageSelector.insertBefore(newOption, addOption);
            }

            function saveCustomLanguage(language) {
                const customLanguages = JSON.parse(localStorage.getItem('customLanguages') || '[]');
                if (!customLanguages.includes(language)) {
                    customLanguages.push(language);
                    localStorage.setItem('customLanguages', JSON.stringify(customLanguages));
                }
            }

            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            // Auto-resize preview textarea
            previewQuestionInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Allow Shift+Enter for new line, Enter to submit in preview textarea
            previewQuestionInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPreview();
                }
            });
        });

        // DOM elements
        const form = document.getElementById('question-form');
        const questionInput = document.getElementById('question');
        const chatMessages = document.getElementById('chat-messages');
        const imageInput = document.getElementById('image');
        const typingIndicator = document.getElementById('typing-indicator');
        const toast = document.getElementById('toast');
        const cameraButton = document.getElementById('camera-btn');
        const cameraModal = document.getElementById('camera-modal');
        const cameraVideo = document.getElementById('camera-video');
        const cameraCanvas = document.getElementById('camera-canvas');
        let stream = null;
        let cropper = null;
        let currentPreviewImage = null;

        // Image input handler
        imageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image size should be less than 5MB', 'error');
                    this.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    currentPreviewImage = e.target.result;
                    const previewImg = document.getElementById('full-preview');
                    previewImg.src = currentPreviewImage;
                    document.getElementById('preview-modal').style.display = 'flex';
                    document.getElementById('crop-btn').style.display = 'inline-block';
                    document.getElementById('preview-question').value = questionInput.value;
                };
                reader.readAsDataURL(file);
            }
        });

        // Camera button handler
        cameraButton.addEventListener('click', async () => {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showToast('Camera access is not supported in this app. Please check app settings.', 'error');
                    console.error('getUserMedia not supported');
                    return;
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                cameraVideo.srcObject = stream;
                cameraModal.style.display = 'flex';
                showToast('Camera accessed successfully', 'success');
                console.log('Camera stream started');
            } catch (error) {
                let errorMessage = 'Failed to access camera';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Camera access denied. Please enable camera permissions in Settings > Apps > Bryn > Permissions.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera found on this device.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Camera access requires a secure connection (HTTPS). Contact support.';
                } else {
                    errorMessage = `Camera error: ${error.message}`;
                }
                showToast(errorMessage, 'error');
                console.error('Camera access error:', error);
            }
        });


        // Autofocus on touch in the middle of the camera view
cameraVideo.addEventListener('touchstart', async (event) => {
    event.preventDefault(); // Prevent default touch behavior like scrolling
    try {
        if (!stream) {
            showToast('Camera stream not active', 'error');
            console.error('No active camera stream');
            return;
        }

        const videoRect = cameraVideo.getBoundingClientRect();
        const touch = event.touches[0];
        const touchX = touch.clientX - videoRect.left;
        const touchY = touch.clientY - videoRect.top;

        // Define the middle region (e.g., 50% of the video width and height)
        const middleWidth = videoRect.width * 0.5;
        const middleHeight = videoRect.height * 0.5;
        const isMiddle = touchX > videoRect.width * 0.25 && touchX < videoRect.width * 0.75 &&
                         touchY > videoRect.height * 0.25 && touchY < videoRect.height * 0.75;

        if (!isMiddle) {
            console.log('Touch outside middle region, ignoring autofocus');
            return;
        }

        // Get the video track from the stream
        const videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        // Check if focusMode is supported (browser-specific, experimental)
        if ('focusMode' in capabilities) {
            try {
                await videoTrack.applyConstraints({
                    advanced: [{ focusMode: 'continuous' }] // Attempt continuous autofocus
                });
                showToast('Autofocus triggered', 'success');
                console.log('Autofocus applied successfully');
            } catch (err) {
                showToast('Autofocus not supported or failed', 'error');
                console.error('Error applying autofocus:', err);
            }
        } else {
            // Fallback: Reapply constraints to reset focus (may trigger device autofocus)
            try {
                await videoTrack.applyConstraints({
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    focusMode: 'auto' // Fallback, may not work in all browsers
                });
                showToast('Autofocus attempted', 'success');
                console.log('Autofocus fallback applied');
            } catch (err) {
                showToast('Autofocus not supported on this device', 'error');
                console.error('Error in autofocus fallback:', err);
            }
        }
    } catch (error) {
        showToast('Error handling touch autofocus', 'error');
        console.error('Touch autofocus error:', error);
    }
});

// Track flash state
let isFlashOn = false;

// Toggle flashlight
window.toggleFlash = async function () {
    try {
        if (!stream) {
            showToast('Camera stream not active', 'error');
            console.error('No active camera stream for flash');
            return;
        }

        const videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        // Check if torch is supported
        if (!capabilities.torch) {
            showToast('Flashlight not supported on this device', 'error');
            console.error('Torch capability not available');
            return;
        }

        // Toggle flash state
        isFlashOn = !isFlashOn;
        await videoTrack.applyConstraints({
            advanced: [{ torch: isFlashOn }]
        });

        // Update button text
        const flashButton = document.getElementById('flash-btn');
        flashButton.textContent = `Flash: ${isFlashOn ? 'On' : 'Off'}`;
        showToast(`Flashlight turned ${isFlashOn ? 'on' : 'off'}`, 'success');
        console.log(`Flashlight ${isFlashOn ? 'enabled' : 'disabled'}`);
    } catch (error) {
        showToast('Failed to toggle flashlight', 'error');
        console.error('Flash toggle error:', error);
        isFlashOn = !isFlashOn; // Revert state on error
        const flashButton = document.getElementById('flash-btn');
        flashButton.textContent = `Flash: ${isFlashOn ? 'On' : 'Off'}`;
    }
};

// Update closeCameraModal to turn off flash when closing
window.closeCameraModal = function () {
    if (stream) {
        if (isFlashOn) {
            const videoTrack = stream.getVideoTracks()[0];
            videoTrack.applyConstraints({ advanced: [{ torch: false }] })
                .catch(err => console.error('Error turning off flash:', err));
            isFlashOn = false;
            document.getElementById('flash-btn').textContent = 'Flash: Off';
        }
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        console.log('Camera stream stopped');
    }
    cameraModal.style.display = 'none';
};

        // Capture image from camera
        window.captureImage = function() {
            try {
                if (!cameraVideo.videoWidth || !cameraVideo.videoHeight) {
                    showToast('Camera not ready. Please try again.', 'error');
                    console.error('Camera not ready for capture');
                    return;
                }
                cameraCanvas.width = cameraVideo.videoWidth;
                cameraCanvas.height = cameraVideo.videoHeight;
                const context = cameraCanvas.getContext('2d');
                context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);

                currentPreviewImage = cameraCanvas.toDataURL('image/jpeg', 0.8);
                const previewImg = document.getElementById('full-preview');
                previewImg.src = currentPreviewImage;
                document.getElementById('preview-modal').style.display = 'flex';
                document.getElementById('crop-btn').style.display = 'inline-block';
                document.getElementById('preview-question').value = questionInput.value;

                const imageId = 'img-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                saveImageToLocalStorage(imageId, currentPreviewImage);

                closeCameraModal();
                showToast('Image captured successfully', 'success');
                console.log('Image captured and saved to localStorage');
            } catch (error) {
                showToast('Failed to capture image: ' + error.message, 'error');
                console.error('Capture error:', error);
            }
        };

        // Start cropping
        window.startCrop = function() {
            const previewImg = document.getElementById('full-preview');
            const cropperImg = document.getElementById('cropper-image');
            const cropperContainer = document.getElementById('cropper-container');
            const cropBtn = document.getElementById('crop-btn');
            const confirmCropBtn = document.getElementById('confirm-crop-btn');

            previewImg.style.display = 'none';
            cropperContainer.style.display = 'block';
            cropBtn.style.display = 'none';
            confirmCropBtn.style.display = 'inline-block';

            cropperImg.src = currentPreviewImage;
            cropper = new Cropper(cropperImg, {
                aspectRatio: NaN,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                zoomable: true,
                scalable: true,
                movable: true
            });
        };

        // Confirm crop and update preview
        window.confirmCrop = function() {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    maxWidth: 1280,
                    maxHeight: 720,
                    imageSmoothingQuality: 'high'
                });
                currentPreviewImage = croppedCanvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('full-preview').src = currentPreviewImage;
                document.getElementById('cropper-container').style.display = 'none';
                document.getElementById('full-preview').style.display = 'block';
                document.getElementById('crop-btn').style.display = 'inline-block';
                document.getElementById('confirm-crop-btn').style.display = 'none';
                cropper.destroy();
                cropper = null;
            }
        };

        // Close camera modal and stop stream
        window.closeCameraModal = function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                console.log('Camera stream stopped');
            }
            cameraModal.style.display = 'none';
        };

        // Close preview modal
        window.closePreview = function() {
            document.getElementById('preview-modal').style.display = 'none';
            document.getElementById('cropper-container').style.display = 'none';
            document.getElementById('full-preview').style.display = 'block';
            document.getElementById('crop-btn').style.display = 'none';
            document.getElementById('confirm-crop-btn').style.display = 'none';
            imageInput.value = '';
            document.getElementById('preview-question').value = '';
            currentPreviewImage = null;
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        };

        // Send preview message
        window.sendPreview = function() {
            const messageText = document.getElementById('preview-question').value.trim();
            const language = document.getElementById('language').value;

            if (!messageText && !currentPreviewImage) {
                showToast('Please enter a message or select/capture an image', 'warning');
                return;
            }

            addUserMessage(messageText, currentPreviewImage);
            showTypingIndicator();

            const formData = new FormData();
            if (messageText) formData.append('question', messageText);
            if (currentPreviewImage) {
                const blob = dataURLtoBlob(currentPreviewImage);
                formData.append('image', blob, 'captured_image.jpg');
            }
            formData.append('language', language);

            closePreview();
            questionInput.value = '';
            document.getElementById('preview-question').value = '';
            currentPreviewImage = null;

            fetch('/ask', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                removeTypingIndicator();
                if (data.success) {
                    addBotMessage(data.response);
                } else {
                    addErrorMessage(data.error);
                }
            })
            .catch(error => {
                removeTypingIndicator();
                addErrorMessage(`Network error: ${error.message}`);
            });
        };

        // Helper function to convert data URL to Blob
        function dataURLtoBlob(dataURL) {
            const byteString = atob(dataURL.split(',')[1]);
            const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        // Show typing indicator
        function showTypingIndicator() {
            removeTypingIndicator();
            const typingElement = document.createElement('div');
            typingElement.className = 'message bot-message typing-indicator-message';
            typingElement.innerHTML = `
                <div class="message-content">
                    <div class="message-sender">BRYN AI BOT</div>
                    <div class="typing-message">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingElement);
            scrollToBottom();
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const existingTyping = document.querySelector('.typing-indicator-message');
            if (existingTyping) {
                existingTyping.remove();
            }
        }

        // Form submission for main textarea
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = questionInput.value.trim();
            const language = document.getElementById('language').value;

            if (!userMessage) {
                showToast('Please enter a message', 'warning');
                return;
            }

            addUserMessage(userMessage);
            showTypingIndicator();

            const formData = new FormData();
            formData.append('question', userMessage);
            formData.append('language', language);

            if (imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }

            questionInput.value = '';
            imageInput.value = '';

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                removeTypingIndicator();
                if (data.success) {
                    addBotMessage(data.response);
                } else {
                    addErrorMessage(data.error);
                }
            } catch (error) {
                removeTypingIndicator();
                addErrorMessage(`Network error: ${error.message}`);
            }
        });

        // Add user message
        function addUserMessage(text, imageUrl = null) {
            let messageHtml = '';
            let imageId = null;

            if (text) {
                messageHtml += `<div class="message-text">${text.replace(/\n/g, '<br>')}</div>`;
            }

            if (imageUrl) {
                imageId = 'img-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                messageHtml += `<div class="message-image"><img src="${imageUrl}" alt="Uploaded image" data-image-id="${imageId}"></div>`;
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message animate__animated animate__fadeInRight';
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-sender">You</div>
                    ${messageHtml}
                </div>
            `;
            chatMessages.appendChild(messageElement);
            scrollToBottom();

            if (imageUrl && imageId) {
                saveImageToLocalStorage(imageId, imageUrl);
            }

            saveMessages();
        }

        // Add bot message
        function addBotMessage(text) {
            removeTypingIndicator();
            const messageElement = document.createElement('div');
            messageElement.className = 'message bot-message animate__animated animate__fadeInLeft';
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-sender">BRYN AI BOT</div>
                    <div class="message-text">${text.replace(/\n/g, '<br>')}</div>
                    <div class="message-actions">
                        <button class="copy-btn" onclick="copyMessage(this)"><i class="far fa-copy"></i></button>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageElement);
            scrollToBottom();
            saveMessages();
            typewriterEffect(messageElement.querySelector('.message-text'), text);
        }

        // Add error message
        function addErrorMessage(error) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message error-message animate__animated animate__fadeIn';
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-sender">Error</div>
                    <div class="message-text">${error}</div>
                </div>
            `;
            chatMessages.appendChild(messageElement);
            scrollToBottom();
            saveMessages();
        }

        // Save image to localStorage
        function saveImageToLocalStorage(imageId, imageData) {
            try {
                const storedImages = JSON.parse(localStorage.getItem('chatImages') || '{}');
                storedImages[imageId] = imageData;
                localStorage.setItem('chatImages', JSON.stringify(storedImages));
            } catch (e) {
                console.error('Error saving image to localStorage:', e);
            }
        }

        // Get image from localStorage
        function getImageFromLocalStorage(imageId) {
            try {
                const storedImages = JSON.parse(localStorage.getItem('chatImages') || '{}');
                return storedImages[imageId] || null;
            } catch (e) {
                console.error('Error retrieving image from localStorage:', e);
                return null;
            }
        }

        // Save messages to localStorage
        function saveMessages() {
            try {
                const messagesClone = chatMessages.cloneNode(true);
                const images = messagesClone.querySelectorAll('.message-image img');
                images.forEach(img => {
                    const imageId = img.getAttribute('data-image-id');
                    if (imageId) {
                        img.setAttribute('src', `local:${imageId}`);
                    }
                });
                localStorage.setItem('chatHistory', messagesClone.innerHTML);
                localStorage.setItem('lastSaved', Date.now());
            } catch (e) {
                console.error('Error saving messages:', e);
            }
        }

        // Load messages from localStorage
        function loadMessages() {
            try {
                const savedMessages = localStorage.getItem('chatHistory');
                if (savedMessages) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = savedMessages;
                    const images = tempDiv.querySelectorAll('.message-image img');
                    images.forEach(img => {
                        const src = img.getAttribute('src');
                        if (src && src.startsWith('local:')) {
                            const imageId = src.substring(6);
                            const imageData = getImageFromLocalStorage(imageId);
                            if (imageData) {
                                img.setAttribute('src', imageData);
                                img.setAttribute('data-image-id', imageId);
                            } else {
                                img.setAttribute('src', 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#eee"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="#aaa">Image not found</text></svg>');
                            }
                        }
                    });
                    chatMessages.innerHTML = tempDiv.innerHTML;
                    scrollToBottom();
                }
            } catch (e) {
                console.error('Error loading messages:', e);
            }
        }

        // Clear message history
        function clearMessageHistory() {
            localStorage.removeItem('chatHistory');
            localStorage.removeItem('chatImages');
            localStorage.removeItem('customLanguages');
            localStorage.removeItem('lastSaved');
            location.reload();
        }

        // Typewriter effect
        function typewriterEffect(element, text) {
            element.innerHTML = '';
            let i = 0;
            const speed = 20;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                    scrollToBottom();
                }
            }
            type();
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Copy message to clipboard
        function copyMessage(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text').textContent;
            navigator.clipboard.writeText(messageText).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                showToast('Failed to copy', 'error');
            });
        }

        // Auto-resize main textarea
        questionInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Allow Shift+Enter for new line, Enter to submit in main textarea
        questionInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });

        function clearImagePreview() {
            imagePreview.innerHTML = '';
            imageInput.value = '';
        }

        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type} animate__animated animate__fadeInUp`;

            setTimeout(() => {
                toast.classList.remove('animate__fadeInUp');
                toast.classList.add('animate__fadeOutDown');
            }, 3000);

            setTimeout(() => {
                toast.className = 'toast';
            }, 3500);
        }

        // Auto-resize textarea
        questionInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Allow Shift+Enter for new line, Enter to submit
        questionInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });

        document.getElementById('clear-history').addEventListener('click', (e) => {
            if (confirm('Are you sure you want to clear all chat history?')) {
                clearMessageHistory();
                showToast('Chat history cleared');
            }
        });
    </script>
</body>
</html>